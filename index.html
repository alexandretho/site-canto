<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Canto & Fono ‚Äì Posts (Issues)</title>
  <meta name="description" content="Lista de posts gerados por IA via Issues do GitHub."/>
  <style>
    :root{
      --blur-bg: rgba(0,0,0,.55);
      --card: rgba(0,0,0,.65);
      --text: #ffffff;
      --muted:#cbb8ff;
      --accent:#b388ff;
      --border: rgba(255,255,255,.12);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      color:var(--text);
      background: #120828 url('fundo.jpg') center/cover fixed no-repeat;
    }
    header{
      backdrop-filter: blur(6px);
      background: var(--blur-bg);
      border-bottom:1px solid var(--border);
      padding: 18px 16px;
    }
    .wrap{max-width: 980px; margin:0 auto}
    h1{margin:0; font-size: 22px}
    .subtitle{color:var(--muted); margin-top:6px}
    main{padding:18px 16px}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0}
    input,select{
      background: transparent;
      color: var(--text);
      border:1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    .grid{display:grid; grid-template-columns:1fr; gap:14px}
    @media(min-width:740px){ .grid{grid-template-columns:1fr 1fr} }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      display:flex; flex-direction:column; gap:10px;
    }
    .title{font-weight:700; font-size:18px; line-height:1.35}
    .meta{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tag{border:1px solid var(--border); border-radius:999px; padding:3px 8px; color:var(--accent)}
    .content{line-height:1.6}
    .empty{color:#e6dfff; opacity:.8; text-align:center; padding:24px; border:1px dashed var(--border); border-radius:var(--radius)}
    footer{color:var(--muted); text-align:center; padding:22px 16px}
    a{color:inherit; text-decoration:none}
    .more{margin-top:6px; color: var(--accent); font-size:14px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üé§ Canto & üó£Ô∏è Fono ‚Äì Posts (via Issues)</h1>
      <div class="subtitle">Posts criados pela IA como Issues p√∫blicas no seu reposit√≥rio GitHub</div>
      <div class="toolbar">
        <input id="q" type="search" placeholder="Filtrar (ex.: belting, passaggio, mentoria)" />
        <select id="limit">
          <option value="6">6 itens</option>
          <option value="9" selected>9 itens</option>
          <option value="12">12 itens</option>
          <option value="20">20 itens</option>
        </select>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none"></div>
    </div>
  </main>

  <footer>
    Use <code>?repo=alexandretho.github.io/site-canto&labels=post,publicar&limit=12</code> na URL para configurar sem editar c√≥digo.
  </footer>

<script>
/** ============ Config ============ **/
const params = new URLSearchParams(location.search);
const CONFIG = {
  owner: (params.get('repo') || 'alexandretho.github.io/site-canto').split('/')[0],
  repo:  (params.get('repo') || 'alexandretho.github.io/site-canto').split('/')[1],
  labels: (params.get('labels') || 'post,publicar')
            .split(',').map(s => s.trim()).filter(Boolean),
  defaultLimit: parseInt(params.get('limit') || '9', 10) || 9
};

// Tema opcional
(function applyTheme(){
  const preset = params.get('preset');
  if(preset === 'purple'){
    document.documentElement.style.setProperty('--card','rgba(27,16,51,.72)');
    document.documentElement.style.setProperty('--accent','#b388ff');
    document.documentElement.style.setProperty('--muted','#c9a8ff');
  }
})();

/** ============ Helpers ============ **/
const grid = document.getElementById('grid');
const emptyBox = document.getElementById('empty');
const qInput = document.getElementById('q');
const limitSel = document.getElementById('limit');

function fmtDate(iso){
  try {
    return new Date(iso).toLocaleString('pt-BR', { dateStyle:'short', timeStyle:'short' });
  } catch { return iso; }
}

async function renderMarkdownGFM(text){
  try{
    const res = await fetch('https://api.github.com/markdown', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ text, mode:'gfm', context:`${CONFIG.owner}/${CONFIG.repo}` })
    });
    if(!res.ok) throw new Error('md render fail');
    return await res.text();
  }catch(e){
    const esc = (s)=> s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    return '<pre style="white-space:pre-wrap;margin:0">'+esc(text)+'</pre>';
  }
}

/** ============ Data Fetch (sem labels, filtrando no cliente = OR) ============ **/
async function fetchIssues(){
  const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues?state=open&per_page=50&sort=created&direction=desc`;
  const res = await fetch(url, {
    headers:{
      'Accept':'application/vnd.github+json',
      'User-Agent': 'gh-issues-reader' // ajuda com alguns gateways
    }
  });
  if(!res.ok) throw new Error('Falha ao carregar issues: '+res.status);
  const data = await res.json();
  return data.filter(it => !it.pull_request);
}

function hasAnyWantedLabel(issue){
  if(!CONFIG.labels.length) return true;
  const names = (issue.labels || []).map(l => (l.name||'').toLowerCase());
  return CONFIG.labels.some(w => names.includes(w.toLowerCase()));
}

/** ============ UI ============ **/
let ALL = [];
async function load(){
  try{
    limitSel.value = String(CONFIG.defaultLimit);
    const issues = await fetchIssues();
    const filtered = issues.filter(hasAnyWantedLabel);
    if(!filtered.length){
      emptyBox.style.display = 'block';
      emptyBox.textContent = 'Nenhum post encontrado com as labels: '+(CONFIG.labels.join(', ')||'(todas)');
      return;
    }
    // Pr√©-render markdown em paralelo
    const rendered = await Promise.all(filtered.map(async (it) => ({
      number: it.number,
      title: it.title,
      created_at: it.created_at,
      labels: it.labels?.map(l => l.name) || [],
      html: await renderMarkdownGFM(it.body || '')
    })));
    ALL = rendered;
    render();
  }catch(e){
    emptyBox.style.display = 'block';
    emptyBox.textContent = 'Erro ao carregar posts. Verifique o ?repo=OWNER/REPO e se as issues s√£o p√∫blicas.';
    console.error(e);
  }
}

function render(){
  const q = (qInput.value||'').toLowerCase().trim();
  const limit = parseInt(limitSel.value,10)||CONFIG.defaultLimit;
  let list = ALL;
  if(q){
    list = list.filter(it =>
      (it.title+' '+it.html.replace(/<[^>]+>/g,' ')).toLowerCase().includes(q)
    );
  }
  grid.innerHTML = '';
  emptyBox.style.display = list.length ? 'none' : 'block';
  if(!list.length){
    emptyBox.textContent = 'Nada encontrado com esse filtro.';
    return;
  }
  for(const it of list.slice(0, limit)){
    const card = document.createElement('article');
    card.className = 'card';
    const labelsHtml = it.labels.slice(0,2).map(l => `<span class="tag">${l}</span>`).join(' ');
    card.innerHTML = `
      <div class="title">${it.title}</div>
      <div class="meta">
        ${labelsHtml ? labelsHtml+'<span>‚Ä¢</span>' : ''}
        <time>${fmtDate(it.created_at)}</time>
        <span>‚Ä¢</span>
        <a class="more" href="https://github.com/${CONFIG.owner}/${CONFIG.repo}/issues/${it.number}" target="_blank" rel="noopener">Ver no GitHub ‚Üí</a>
      </div>
      <div class="content">${it.html}</div>
    `;
    grid.appendChild(card);
  }
}

qInput.addEventListener('input', render);
limitSel.addEventListener('change', render);

load();
</script>
</body>
</html>
